name: Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  merge_group:

jobs:
  test-x86_64-unknown-linux-gnu:
    runs-on: depot-ubuntu-24.04-16

    steps:
      - uses: actions/checkout@v6

      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2

      - uses: taiki-e/install-action@v2
        with:
          tool: cargo-nextest

      - name: Run tests
        env:
          PROPTEST_CASES: 0
        run: |
          cargo nextest run

  clippy:
    runs-on: depot-ubuntu-24.04-4

    steps:
      - uses: actions/checkout@v6

      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2

      - name: Run clippy
        run: |
          cargo clippy --workspace --all-features --all-targets --keep-going -- -D warnings --allow deprecated

  lockfile:
    runs-on: depot-ubuntu-24.04-4

    steps:
      - uses: actions/checkout@v6

      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2

      - name: Check lockfile is updated
        run: |
          cargo update --workspace --locked

  docs:
    runs-on: depot-ubuntu-24.04-4

    steps:
      - uses: actions/checkout@v6

      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2

      - name: Check documentation
        env:
          RUSTDOCFLAGS: -D warnings
        run: |
          cargo doc --workspace --no-deps

  test-wasm-browser:
    runs-on: depot-ubuntu-24.04-4

    steps:
      - uses: actions/checkout@v6

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Ensure WASM target is installed
        run: rustup target add wasm32-unknown-unknown

      - uses: Swatinem/rust-cache@v2

      - uses: pnpm/action-setup@v4
        with:
          version: 9

      - uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install wasm-pack
        run: cargo install wasm-pack

      - name: Install dependencies
        working-directory: hotmeal-wasm
        run: pnpm install

      - name: Install Playwright browsers
        working-directory: hotmeal-wasm
        run: pnpm exec playwright install chromium

      - name: Run browser tests
        working-directory: hotmeal-wasm
        run: pnpm test

  test-browser-fuzz:
    runs-on: depot-ubuntu-24.04-4

    steps:
      - uses: actions/checkout@v6

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - uses: Swatinem/rust-cache@v2

      - name: Install wasm-pack
        run: cargo install wasm-pack

      - name: Build browser-wasm bundle
        working-directory: hotmeal/fuzz/browser-wasm
        run: wasm-pack build --target web --out-dir ../browser-bundle/dist

      - name: Run browser tests
        working-directory: hotmeal/fuzz
        run: cargo test --test browser_tests
        # thrall will auto-download Chrome if needed via chromiumoxide fetcher
